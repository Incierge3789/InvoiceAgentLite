Open main.py and add a JP invoice extraction rule pack, then wire it to the existing PDF upload endpoint without changing the framework or deployment.

1) Insert the following code block right below the current imports:

[CODE]
import re, unicodedata
AMOUNT_RE = re.compile(r'(?:ご?\s*請求(?:金額|合計)|税込?合計|合計)[^\d]*(\d{1,3}(?:,\d{3})+|\d+)\s*円?')
DATE_RE   = re.compile(r'(?:発行日|請求日|納品日|支払期限)[^\d]*(\d{4}[./年]\s*\d{1,2}[./月]\s*\d{1,2}日?)')
VENDOR_RE = re.compile(r'(?:株式会社|有限会社|合同会社)[^\n]+|.+?御中')
def _normalize(txt: str) -> str:
    import unicodedata, re
    t = unicodedata.normalize('NFKC', txt).replace('\u3000',' ')
    return re.sub(r'[ \t]+', ' ', t)
def extract_fields_jp(text: str):
    t = _normalize(text)
    amount = None
    m = AMOUNT_RE.search(t)
    if m: amount = int(m.group(1).replace(',', ''))
    date = None
    dm = DATE_RE.search(t)
    if dm:
        date = dm.group(1)
        date = (date.replace('年','-').replace('月','-').replace('日','')
                    .replace('/','-').replace('.','-'))
        import re
        date = re.sub(r'\s+', '', date)
    vendor = None
    head = '\n'.join(t.splitlines()[:20])
    vm = VENDOR_RE.search(head)
    if vm: vendor = vm.group(0).replace('御中','').strip()
    score = sum(x is not None for x in [amount, date, vendor]) / 3
    return {
        "amount": amount, "date": date, "vendor": vendor,
        "confidence": round(score, 2),
        "needs_review": "TRUE" if score < 0.8 else "FALSE",
    }
[/CODE]

2) In the API handler that processes an uploaded PDF (the endpoint that currently builds the variable `text` with the whole PDF content), after `text` is ready, replace the response building code with:
- If this is a Flask app:
    `from flask import jsonify`
    `fields = extract_fields_jp(text)`
    `return jsonify(ok=True, file=f.filename, raw_excerpt=text[:500], **fields)`
- If this is a FastAPI app:
    `from fastapi.responses import JSONResponse`
    `fields = extract_fields_jp(text)`
    `return JSONResponse(content={"ok": True, "file": f.filename, "raw_excerpt": text[:500], **fields})`

3) Do NOT change .replit, deployment settings, routes, or the HTML upload page. Keep endpoints /upload, /api/upload, /healthz, /selfcheck intact.

4) Run the app and show me a test by uploading a Japanese invoice PDF (you can use the existing sample), and paste the JSON output here. The output must include keys: ok, file, raw_excerpt, amount, date, vendor, confidence, needs_review.